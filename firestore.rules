
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---

    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/admin) &&
             get(/databases/$(database)/documents/users/admin).data.get('uid', '') == request.auth.uid;
    }

    // Helper: Normalize email to lowercase for comparison
    function isEmailMatch(id) {
       return request.auth.token.email.lower() == (id + '@shyuan-hrm.com').lower();
    }

    // Helper: Check if the user owns the document (Read/Update/Delete context)
    function isResourceOwner() {
      let docUid = resource.data.get('uid', null);
      let docUserId = resource.data.get('userId', '');
      
      return request.auth != null && (
        (docUid != null && docUid == request.auth.uid) || 
        (docUserId != '' && isEmailMatch(docUserId))
      );
    }

    // Helper: Check if the user is creating data for themselves (Create context)
    function isCreatingOwnResource() {
       return request.auth != null && (
         request.resource.data.get('uid', '') == request.auth.uid ||
         isEmailMatch(request.resource.data.get('userId', ''))
       );
    }

    // --- Collection Rules ---

    // Security Logs (New)
    match /security_logs/{logId} {
      // 允許所有已認證使用者寫入日誌 (為了記錄異常嘗試)
      allow create: if request.auth != null;
      // 僅管理員可讀取與管理日誌
      allow read, update, delete: if isAdmin();
    }

    // Users Collection
    match /users/{userId} {
      // Security fix: Employees can only read their own data. Admin can read all.
      allow read: if isAdmin() || (request.auth != null && (userId == 'admin' ? false : isResourceOwner()));
      
      // Write Rules (Update/Create)
      allow write: if 
        // 1. 管理員擁有完全權限
        isAdmin() || 
        (
          request.auth != null &&
          
          // 2. 安全核心：絕對禁止非管理員寫入/覆蓋 'admin' 文件
          userId != 'admin' &&
          
          // 3. 權限檢查：必須是該文件的擁有者
          (isEmailMatch(userId) || resource == null || resource.data.get('uid', '') == request.auth.uid) &&
          
          // 4. 防止權限提升 (Privilege Escalation)
          // 嘗試寫入的 role 必須是 'employee'，或者保持原值不變 (不能把自己改成 admin)
          (request.resource.data.get('role', 'employee') == 'employee' || request.resource.data.get('role', '') == resource.data.get('role', '')) &&
          
          // 5. 資料完整性保護 (Data Integrity)
          // 更新時：禁止修改額度、到職日、部門
          // 創建時：允許 (Login.tsx 自動建立檔案時會寫入初始值)
          (
            resource == null || 
            (
              // 禁止修改假別額度
              request.resource.data.get('quota_annual', 0) == resource.data.get('quota_annual', 0) &&
              request.resource.data.get('quota_birthday', 0) == resource.data.get('quota_birthday', 0) &&
              request.resource.data.get('quota_comp', 0) == resource.data.get('quota_comp', 0) &&
              // 禁止修改人事核心資料 (防止員工竄改年資或部門)
              request.resource.data.get('onboard_date', '') == resource.data.get('onboard_date', '') &&
              request.resource.data.get('dept', '') == resource.data.get('dept', '')
            )
          )
        );
    }

    // Records (Attendance)
    match /records/{recordId} {
      allow read: if isAdmin() || isResourceOwner();
      // 建立打卡紀錄：必須是本人
      allow create: if isCreatingOwnResource();
      // 修改/刪除：僅限管理員
      allow update, delete: if isAdmin();
    }

    // Leaves (Requests)
    match /leaves/{leaveId} {
      allow read: if isAdmin() || isResourceOwner();
      
      // 建立假單：
      // 1. 必須是本人
      // 2. [安全性修正] 狀態必須強制為 'pending'，防止員工自我核准
      allow create: if isCreatingOwnResource() && request.resource.data.status == 'pending';
      
      // 更新規則：本人只能將狀態改為 cancelled (取消申請)
      allow update: if isAdmin() || (
        isResourceOwner() && 
        request.resource.data.status == 'cancelled' &&
        // 防止在取消時順便修改時數或事由
        request.resource.data.hours == resource.data.hours &&
        request.resource.data.type == resource.data.type
      );
      
      // 刪除規則：僅限管理員
      allow delete: if isAdmin();
    }

    // Overtimes (Requests)
    match /overtimes/{otId} {
      allow read: if isAdmin() || isResourceOwner();
      
      // 建立加班單：
      // 1. 必須是本人
      // 2. [安全性修正] 狀態必須強制為 'pending'，防止員工自我核准
      allow create: if isCreatingOwnResource() && request.resource.data.status == 'pending';
      
      // 更新規則：本人只能將狀態改為 cancelled
      allow update: if isAdmin() || (
        isResourceOwner() && 
        request.resource.data.status == 'cancelled' &&
        request.resource.data.hours == resource.data.hours
      );
      
      // 刪除規則：僅限管理員
      allow delete: if isAdmin();
    }

    // Public/System Data
    match /announcements/{annId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /holidays/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /system/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
